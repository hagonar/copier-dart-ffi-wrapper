# {{ package_name }} - Claude Code Configuration

## Important Rules

**ALWAYS use Makefile commands.** Never call scripts directly via `fvm dart run scripts/...`. The Makefile is the single entry point for all operations.

```bash
# Correct - pass arguments via ARGS variable
make build ARGS="macos"
make build ARGS="macos --arch arm64"
make test
make analyze ARGS="--fatal-infos"

# Wrong - never do this
fvm dart run scripts/build.dart macos
make build macos --arch arm64  # make interprets --arch as its own flag!
```

## Quick Reference

| Task | Command |
|------|---------|
| Initial setup | `make setup` |
| Show all commands | `make help` |
| Build native library | `make build ARGS="<platform>"` |
| Run tests | `make test` |
| Run tests with coverage | `make coverage` |
| Run analysis | `make analyze` |
| Strict analysis | `make analyze ARGS="--fatal-infos"` |
| Format code | `make format` |
| Generate documentation | `make doc` |
| Download headers + regenerate FFI bindings | `make regen` |
| Check for updates | `make check` |
| Get dependencies | `make get` |
| Show {{ native_library_name }} version | `make version` |

## Available Makefile Commands

### Setup
```bash
{% if wrapper_type == 'rust' %}
make setup                        # Full setup (FVM + build dependencies)
make setup-fvm                    # Install FVM + Flutter only
make setup-build                  # Install build dependencies (Rust, protoc)
{% endif %}
{% if wrapper_type == 'c' %}
make setup                        # Install FVM + Flutter + dependencies (run once)
{% endif %}
```

### Build
```bash
make build ARGS="<platform> [options]"     # Build native libraries
make build ARGS="macos"                    # Build for macOS (universal)
make build ARGS="macos --arch arm64"       # Build for specific architecture
make build ARGS="ios"                      # Build for iOS (xcframework)
make build ARGS="ios --target simulator"   # Build for iOS simulator only
make build ARGS="android"                  # Build for Android (all ABIs)
make build ARGS="android --abi arm64-v8a"
make build ARGS="linux"                    # Build for Linux
make build ARGS="windows"                  # Build for Windows
make build ARGS="all"                      # Build all platforms
make build ARGS="list"                     # List available platforms
```

**Note:** `make build` automatically creates a `.skip_{{ package_name }}_hook` marker file to prevent Build Hooks from downloading libraries during the build process. The marker is automatically removed after the build completes.

### Development
```bash
make regen                              # Download headers + regenerate FFI bindings
make check                              # Check for {{ native_library_name }} updates
make check ARGS="--update"              # Check and apply updates
make check ARGS="--ci"                  # Output for CI (GitHub Actions)
make combine                            # Combine CI artifacts
```

### Quality Assurance
```bash
make test                                # Run all tests
make test ARGS="test/example_test.dart"  # Run specific test file
make coverage                            # Run tests with coverage report
make analyze                             # Run static analysis
make analyze ARGS="--fatal-infos"        # Strict analysis
make format                              # Format Dart code
make format-check                        # Check formatting without changes
```

### Utilities
```bash
make get                          # Get dependencies
make clean                        # Clean build artifacts
make version                      # Show current {{ native_library_name }} version
make help                         # Show all available commands
```

## Project Overview

Dart FFI bindings for {{ native_library_name }}.

### Key Features
- Pre-built native libraries for all platforms
- Automated updates via GitHub Actions
- Cross-platform build scripts

### Upstream Repository
- **{{ native_library_name }}**: https://github.com/{{ native_repo }}

## Project Structure

```
{{ package_name }}/
├── lib/                            # Dart library code
│   └── src/bindings/               # Auto-generated FFI bindings
├── bin/                            # Pre-built server/CLI libraries
│   ├── linux/
│   ├── macos/
│   └── windows/
├── android/src/main/jniLibs/       # Android libraries
├── ios/Frameworks/ or ios/Libraries/  # iOS libraries
├── macos/Libraries/                # macOS Flutter library
├── scripts/                        # Build scripts (use via Makefile!)
├── test/                           # Tests
├── Makefile                        # Entry point for all commands
├── pubspec.yaml                    # Package config + {{ package_name }}.native_version
└── .github/workflows/              # CI/CD workflows
```

## Common Development Tasks

### Update {{ native_library_name }} Version

Native library version is stored in `pubspec.yaml` under `{{ package_name }}.native_version`.

```bash
# Option 1: Automatic update
make check ARGS="--update"

# Option 2: Manual update
# 1. Edit pubspec.yaml - update {{ package_name }}.native_version to new version
# 2. Regenerate FFI bindings
make regen

# 3. Run tests
make test

# 4. Commit and push (CI will build native libraries)
git add pubspec.yaml lib/src/bindings/
git commit -m "Update {{ native_library_name }} to X.Y.Z"
git push
```

### Build Native Libraries Locally

```bash
# List available platforms
make build ARGS="list"

# Build for current platform
make build ARGS="macos"
make build ARGS="linux"
make build ARGS="windows"

# Build with options
make build ARGS="macos --arch arm64"
make build ARGS="ios --target device"
make build ARGS="android --abi arm64-v8a"
```

### Run Tests

```bash
# All tests
make test

# Specific test file
make test ARGS="test/example_test.dart"

# With verbose output
make test ARGS="--reporter=expanded"
```

## Supported Platforms

| Platform | Architecture | Location |
|----------|--------------|----------|
| Linux | x86_64, arm64 | `bin/linux/` |
| macOS | Universal (arm64 + x86_64) | `bin/macos/` |
| Windows | x86_64 | `bin/windows/` |
| iOS | XCFramework | `ios/Frameworks/` or `ios/Libraries/` |
| Android | arm64-v8a, armeabi-v7a, x86_64 | `android/src/main/jniLibs/` |

## Security Considerations

> **Important:** See [SECURITY.md](SECURITY.md) for full security policy and best practices.

### Supply Chain Security
- All native libraries are built from source in GitHub Actions
- Pin to specific {{ native_library_name }} releases
- Review upstream changes before merging

### Code Review Checklist
1. No hardcoded keys or secrets
2. Memory properly freed after use
3. Sensitive data zeroed before freeing
4. No timing side-channels

### Security Rules for New Code

When adding new functionality:

1. **Memory Management:**
   - Use `{{ package_name | to_camel }}Utils.secureFreePointer(ptr, length)` for secret data
   - Use `{{ package_name | to_camel }}Utils.freePointer(ptr)` only for non-sensitive data
   - Always free memory in `finally` blocks

2. **Key/Secret Handling:**
   - Add `clearSecrets()` method to any class holding secret keys
   - Add `Finalizer` to auto-zero secrets on GC (defense-in-depth)
   - Document with `/// **Security Warning:**` if methods expose secrets

3. **Comparisons:**
   - Use `{{ package_name | to_camel }}Utils.constantTimeEquals()` for comparing secrets
   - Never use `==` for secret data

4. **Function Pointers:**
   - Validate native function pointers before calling `asFunction()`

5. **dispose() Pattern:**
   - Order: `free() -> detach() -> flag = true`

## FVM (Flutter Version Management)

This project uses FVM for consistent Flutter/Dart versions.

**Version:** Flutter {{ flutter_version }}

FVM is automatically installed by `make setup`.

## Windows Users

On Windows, install `make` first:
- Chocolatey: `choco install make`
- Scoop: `scoop install make`
- Or use Git Bash / WSL

## Changelog Format

Follow [Keep a Changelog](https://keepachangelog.com/en/1.1.0/) format:

```markdown
## X.Y.Z

### Added
- New features

### Changed
- Changes in existing functionality

### Fixed
- Bug fixes

### Security
- Security-related changes
```

## Publishing Checklist

```bash
# 1. Run quality checks
make analyze
make test
make format-check

# 2. Update version in pubspec.yaml
# 3. Update CHANGELOG.md

# 4. Dry run
make publish-dry-run

# 5. Create tag and push (CI will publish)
git tag vX.Y.Z
git push origin vX.Y.Z
```
