#!/usr/bin/env dart
/// Get version information from pubspec.yaml.
///
/// Usage:
///   dart run scripts/get_version.dart [--field <field>]
///
/// Options:
///   --field version  - Print only native_version
///   --field build    - Print only native_build
///   --field full     - Print full version (version-build)
///   --field package  - Print package version
///
/// Without --field, prints all version information.
library;

import 'dart:io';

import 'src/common.dart';

void main(List<String> args) async {
  final field = _parseField(args);
  final packageDir = getPackageDir();

  final version = get{{ package_name | to_camel }}Version();
  final build = await _readNativeBuild(packageDir);
  final fullVersion = '$version-$build';
  final packageVersion = await _readPackageVersion(packageDir);

  switch (field) {
    case 'version':
      print(version);
    case 'build':
      print(build);
    case 'full':
      print(fullVersion);
    case 'package':
      print(packageVersion);
    default:
      print('{{ package_name }} Version Information:');
      print('  Package version: $packageVersion');
      print('  Native version:  $version');
      print('  Native build:    $build');
      print('  Full identifier: $fullVersion');
  }
}

String? _parseField(List<String> args) {
  final index = args.indexOf('--field');
  if (index != -1 && index + 1 < args.length) {
    return args[index + 1];
  }
  return null;
}

Future<String> _readNativeBuild(Directory packageDir) async {
  final pubspecFile = File('${packageDir.path}/pubspec.yaml');
  if (!pubspecFile.existsSync()) {
    return '1';
  }

  final content = await pubspecFile.readAsString();

  final blockMatch = RegExp(
    r'^{{ package_name }}:\s*$([\s\S]*?)(?=^\w|\z)',
    multiLine: true,
  ).firstMatch(content);

  if (blockMatch == null) {
    return '1';
  }

  final block = blockMatch.group(1) ?? '';
  final buildMatch = RegExp(r'native_build:\s*(\d+)').firstMatch(block);

  return buildMatch?.group(1)?.trim() ?? '1';
}

Future<String> _readPackageVersion(Directory packageDir) async {
  final pubspecFile = File('${packageDir.path}/pubspec.yaml');
  if (!pubspecFile.existsSync()) {
    return '0.0.0';
  }

  final content = await pubspecFile.readAsString();
  final versionMatch = RegExp(r'^version:\s*(.+)$', multiLine: true)
      .firstMatch(content);

  return versionMatch?.group(1)?.trim() ?? '0.0.0';
}
