# {{ package_name }} - Makefile
# Cross-platform build and development commands
#
# Usage: make <target> [ARGS="..."]
# Example: make build ARGS="macos --arch arm64"
# Example: make analyze ARGS="--fatal-infos"
#
# On Windows CI (Git Bash), use cmd to run fvm.bat from PATH:
# Example: make build ARGS="windows" FVM="cmd //c fvm"

{% if wrapper_type == 'rust' %}
.PHONY: help setup setup-fvm setup-build build regen check combine test coverage analyze format format-check get clean version get-version get-build get-full-version check-release doc publish publish-dry-run
{% endif %}
{% if wrapper_type == 'c' %}
.PHONY: help setup build regen check combine test coverage analyze format format-check get clean version get-version get-build get-full-version check-release doc publish publish-dry-run
{% endif %}

# FVM command - can be overridden to provide full path on Windows CI
FVM ?= fvm

# Arguments are passed via ARGS variable
ARGS ?=

# Default target
.DEFAULT_GOAL := help

# =============================================================================
# Help
# =============================================================================

help:
	@echo ""
	@echo "{{ package_name }} - Available commands:"
	@echo ""
	@echo "  Pass arguments via ARGS variable: make <target> ARGS=\"...\""
	@echo ""
	@echo "  SETUP"
{% if wrapper_type == 'rust' %}
	@echo "    make setup                        - Full setup (FVM + build dependencies)"
	@echo "    make setup-fvm                    - Install FVM and project Flutter version only"
	@echo "    make setup-build                  - Install native build dependencies (Rust, protoc)"
{% endif %}
{% if wrapper_type == 'c' %}
	@echo "    make setup                        - Install FVM and project Flutter version (run once)"
{% endif %}
	@echo ""
	@echo "  BUILD"
	@echo "    make build ARGS=\"<platform>\"      - Build native libraries"
	@echo "                                        Platforms: macos, ios, android, linux, windows, all, list"
	@echo "                                        Example: make build ARGS=\"macos --arch arm64\""
	@echo ""
	@echo "  DEVELOPMENT"
	@echo "    make regen                        - Regenerate Dart FFI bindings from headers"
	@echo "    make check                        - Check for {{ native_library_name }} updates"
	@echo "                                        Example: make check ARGS=\"--update --version 1.0.0\""
	@echo "    make combine                      - Combine CI artifacts (used by GitHub Actions)"
	@echo ""
	@echo "  QUALITY ASSURANCE"
	@echo "    make test                         - Run tests"
	@echo "                                        Example: make test ARGS=\"test/example_test.dart\""
	@echo "    make coverage                     - Run tests with coverage report"
	@echo "    make analyze                      - Run static analysis"
	@echo "                                        Example: make analyze ARGS=\"--fatal-infos\""
	@echo "    make format                       - Format Dart code"
	@echo "    make format-check                 - Check Dart code formatting"
	@echo "    make doc                          - Generate API documentation"
	@echo ""
	@echo "  PUBLISHING"
	@echo "    make publish-dry-run              - Validate package before publishing"
	@echo "    make publish                      - Publish package (CI only, blocked locally)"
	@echo ""
	@echo "  UTILITIES"
	@echo "    make get                          - Get dependencies"
	@echo "    make clean                        - Clean build artifacts"
	@echo "    make version                      - Show current {{ native_library_name }} version"
	@echo "    make help                         - Show this help message"
	@echo ""

# =============================================================================
# Setup
# =============================================================================

{% if wrapper_type == 'rust' %}
setup: setup-fvm setup-build
	@echo ""
	@echo "Full setup complete! You can now use 'make help' to see available commands."

setup-fvm:
	@echo "Installing FVM (Flutter Version Management)..."
	dart pub global activate fvm
	@echo ""
	@echo "Installing project Flutter version..."
	$(FVM) install
	@echo ""
	@echo "Getting dependencies..."
	$(FVM) dart pub get --no-example
	@echo ""
	@echo "Configuring git hooks..."
	git config core.hooksPath .githooks
	@echo ""
	@echo "FVM setup complete!"

setup-build:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/setup_build.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret
{% endif %}
{% if wrapper_type == 'c' %}
setup:
	@echo "Installing FVM (Flutter Version Management)..."
	dart pub global activate fvm
	@echo ""
	@echo "Installing project Flutter version..."
	$(FVM) install
	@echo ""
	@echo "Getting dependencies..."
	$(FVM) dart pub get --no-example
	@echo ""
	@echo "Configuring git hooks..."
	git config core.hooksPath .githooks
	@echo ""
	@echo "Setup complete! You can now use 'make help' to see available commands."
{% endif %}

# =============================================================================
# Build
# =============================================================================

build:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/build.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

# =============================================================================
# Development
# =============================================================================

regen:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/regenerate_bindings.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

check:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/check_updates.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

combine:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/combine_artifacts.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

# =============================================================================
# Quality Assurance
# =============================================================================

test:
	$(FVM) dart test $(ARGS)

coverage:
	$(FVM) dart test --coverage=coverage
	$(FVM) dart run coverage:format_coverage --check-ignore --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
	lcov --remove coverage/lcov.info 'lib/src/bindings/*' -o coverage/lcov.info
	lcov --summary coverage/lcov.info

analyze:
	$(FVM) flutter analyze $(ARGS)

format:
	$(FVM) dart format . $(ARGS)

format-check:
	$(FVM) dart format --set-exit-if-changed . $(ARGS)

doc:
	rm -rf doc
	$(FVM) dart doc $(ARGS)
	@echo ""
	@echo "Documentation generated in doc/api/"
	@echo "Open doc/api/index.html to view locally"

# =============================================================================
# Utilities
# =============================================================================

get:
	$(FVM) dart pub get --no-example

clean:
	rm -rf .dart_tool build
	$(FVM) dart pub get --no-example

version:
	@$(FVM) dart run scripts/get_version.dart

# Internal target for getting version in scripts (outputs only the value)
get-version:
	@$(FVM) dart run scripts/get_version.dart --field version

get-build:
	@$(FVM) dart run scripts/get_version.dart --field build

get-full-version:
	@$(FVM) dart run scripts/get_version.dart --field full

check-release:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/check_release.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

# =============================================================================
# Publishing
# =============================================================================

publish-dry-run:
	$(FVM) dart pub publish --dry-run

publish:
ifndef CI
	@echo ""
	@echo "ERROR: Local publishing is disabled."
	@echo ""
	@echo "This package uses automated publishing via GitHub Actions."
	@echo "To publish a new version:"
	@echo ""
	@echo "  1. Update version in pubspec.yaml"
	@echo "  2. Update CHANGELOG.md"
	@echo "  3. Commit and push changes"
	@echo "  4. Create and push a tag: git tag v0.1.0 && git push origin v0.1.0"
	@echo "  5. GitHub Actions will automatically publish to pub.dev"
	@echo ""
	@echo "To validate the package locally, use: make publish-dry-run"
	@echo ""
	@exit 1
else
	$(FVM) dart pub publish $(ARGS)
endif
